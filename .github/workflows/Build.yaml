name: Build and Push Docker Image

on:
  push:
    branches:
      - features.benefitcreateupdate

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up Docker Hub credentials
      - name: Set up Docker Hub credentials
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login --username ${{ secrets.DOCKER_USERNAME }} --password-stdin

      # Step 3: Generate Image Tag and store it in $GITHUB_ENV
      - name: Generate Image Tag
        run: |
          IMAGE_TAG="v1.0.0-$(date +'%Y%m%d-%H%M%S')"  # Create a unique image tag
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV  # Store the IMAGE_TAG in $GITHUB_ENV
          echo "FULL_IMAGE_TAG=prsm323/application:$IMAGE_TAG" >> $GITHUB_ENV  # Store the full image tag

      # Step 4: Build Docker image using the environment variable
      - name: Build Docker image for backend/application
        run: |
          echo "Building Docker image with tag $FULL_IMAGE_TAG"
          docker build -t $FULL_IMAGE_TAG ./backend/application

      # Step 5: Push Docker image to Docker Hub
      - name: Push Docker image to Docker Hub
        run: |
          docker push $FULL_IMAGE_TAG

      # Step 6: Final success message
      - name: Final success message
        run: |
          echo "Successfully built and pushed Docker image: $FULL_IMAGE_TAG"
