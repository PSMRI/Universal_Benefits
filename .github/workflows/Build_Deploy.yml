name: Build, Push Docker Image to Docker Hub and Deploy to EKS

on:
  push:
    branches:
      - features.benefitcreateupdate  # Trigger on push to the main branch
  pull_request:
    branches:
      - features.benefitcreateupdate  # Trigger on PR to the main branch

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up AWS CLI (hardcoded AWS credentials)
      - name: Set up AWS CLI
        run: |
          aws configure set aws_access_key_id AKIA23WHUJCYTHNEENXD
          aws configure set aws_secret_access_key 2zr+YHEbapceKpwfo475i17q1AH/XPC1nm4Nf+70
          aws configure set region ap-south-1  # Change region to your region

      # Step 3: Set up kubectl for EKS
      - name: Set up kubectl for EKS
        run: |
          aws eks update-kubeconfig --region ap-south-1 --name dev-piramal
          kubectl version --client # Verify kubectl is installed

      # Step 4: Set up Docker Hub credentials (hardcoded Docker Hub credentials)
      - name: Set up Docker Hub credentials
        run: |
          echo "Devops@1997" | docker login --username prsm323 --password-stdin
          
      # Step 5: Build Docker image
      - name: Build Docker image
        run: |
          IMAGE_TAG=${GITHUB_SHA}
          docker build -t prsm323/application:$IMAGE_TAG ./backend/application  # Path to Dockerfile is correct

      # Step 6: Push Docker image to Docker Hub
      - name: Push Docker image to Docker Hub
        run: |
          IMAGE_TAG=${GITHUB_SHA}
          docker push prsm323/application:$IMAGE_TAG

      # Step 7: Install Helm
      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version # Verify Helm is installed

      # Step 8: Deploy to EKS using Helm
      - name: Deploy to EKS using Helm
        run: |
          helm upgrade --install backend ./deploy-as-code/charts/uba/backend/application \
            --set backend.image.repository=prsm323/application \
            --set backend.image.tag=$GITHUB_SHA
